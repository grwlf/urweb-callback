# This Makefile was generated by the Cake3
# https://github.com/grwlf/cake3

GUARD = .cake3/GUARD_$(1)_$(shell echo $($(1)) | md5sum | cut -d ' ' -f 1)

ifeq ($(MAIN),1)
unexport MAIN

# Main section

URCPP = $(shell $(shell urweb -print-ccompiler) -print-prog-name=g++)
URINCL = -I$(shell urweb -print-cinclude) 
URVERSION = $(shell urweb -version)
.PHONY: all
all: ./Makefile ./demo/Demo.db ./demo/Demo.exe ./demo/Demo.sql
./demo/Demo.db: ./Makefile ./demo/Demo.exe ./demo/Demo.sql
	dropdb --if-exists Demo
	createdb Demo
	psql -f ./demo/Demo.sql Demo
	touch ./demo/Demo.db
./demo/Demo.exe: .fix-multy1
./demo/Demo.urp: ./Makefile ./demo/Demo.ur ./demo/Demo.urs ./lib.urp .cake3/tmp1
	cat .cake3/tmp1 > ./demo/Demo.urp
.cake3/tmp1: ./Makefile
	-rm -rf .cake3/tmp1
	echo 'allow url http://code.jquery.com/ui/1.10.3/jquery-ui.js' >> .cake3/tmp1
	echo 'allow mime text/javascript' >> .cake3/tmp1
	echo 'allow mime text/css' >> .cake3/tmp1
	echo 'allow mime image/jpeg' >> .cake3/tmp1
	echo 'allow mime image/png' >> .cake3/tmp1
	echo 'allow mime image/gif' >> .cake3/tmp1
	echo 'database dbname=Demo' >> .cake3/tmp1
	echo 'safeGet Demo/main' >> .cake3/tmp1
	echo 'safeGet Demo/job_monitor' >> .cake3/tmp1
	echo 'safeGet Demo/job_start' >> .cake3/tmp1
	echo 'safeGet Demo/finished' >> .cake3/tmp1
	echo 'safeGet Demo/cleanup' >> .cake3/tmp1
	echo 'safeGet Demo/monitor' >> .cake3/tmp1
	echo 'safeGet Demo/run' >> .cake3/tmp1
	echo 'safeGet Demo/C/callback' >> .cake3/tmp1
	echo 'safeGet Demo/Find/C/callback' >> .cake3/tmp1
	echo 'safeGet Demo/Cat/C/callback' >> .cake3/tmp1
	echo 'safeGet Demo/viewsrc' >> .cake3/tmp1
	echo 'safeGet Demo/status' >> .cake3/tmp1
	echo 'sql .././demo/Demo.sql' >> .cake3/tmp1
	echo 'library ../.' >> .cake3/tmp1
	echo 'debug' >> .cake3/tmp1
	echo '' >> .cake3/tmp1
	echo '$$/list' >> .cake3/tmp1
	echo '$$/string' >> .cake3/tmp1
	echo '.././demo/Demo' >> .cake3/tmp1
./lib.urp: ./Callback.ur ./Callback.urs ./CallbackFFI.h ./CallbackFFI.o ./CallbackNotify.ur ./CallbackNotify.urs ./CallbackNotify2.ur ./CallbackNotify2.urs ./Makefile .cake3/tmp0
	cat .cake3/tmp0 > ./lib.urp
.cake3/tmp0: ./Makefile
	-rm -rf .cake3/tmp0
	echo 'ffi ./CallbackFFI' >> .cake3/tmp0
	echo 'include ./CallbackFFI.h' >> .cake3/tmp0
	echo 'link ./CallbackFFI.o' >> .cake3/tmp0
	echo 'link -lstdc++' >> .cake3/tmp0
	echo 'safeGet Callback/Default/callback' >> .cake3/tmp0
	echo 'safeGet CallbackNotify/C/callback' >> .cake3/tmp0
	echo '' >> .cake3/tmp0
	echo './Callback' >> .cake3/tmp0
	echo './CallbackNotify' >> .cake3/tmp0
	echo './CallbackNotify2' >> .cake3/tmp0
./CallbackFFI.o: ./CallbackFFI.cpp ./Makefile $(call GUARD,URCPP) $(call GUARD,URINCL) $(call GUARD,UR_CFLAGS)
	$(URCPP) -c $(UR_CFLAGS) $(URINCL) -std=c++11 -o ./CallbackFFI.o ./CallbackFFI.cpp
./demo/Demo.sql: .fix-multy1
.INTERMEDIATE: .fix-multy1
.fix-multy1: ./Makefile ./demo/Demo.urp $(call GUARD,URVERSION)
	urweb -dbms postgres ./demo/Demo
$(call GUARD,URCPP):
	rm -f .cake3/GUARD_URCPP_*
	touch $@
$(call GUARD,URINCL):
	rm -f .cake3/GUARD_URINCL_*
	touch $@
$(call GUARD,URVERSION):
	rm -f .cake3/GUARD_URVERSION_*
	touch $@
$(call GUARD,UR_CFLAGS):
	rm -f .cake3/GUARD_UR_CFLAGS_*
	touch $@

else

# Prebuild/postbuild section

export MAIN=1

ifneq ($(MAKECMDGOALS),clean)

.PHONY: all
all: .fix-multy1
.PHONY: ./demo/Demo.db
./demo/Demo.db: .fix-multy1
.PHONY: ./demo/Demo.exe
./demo/Demo.exe: .fix-multy1
.PHONY: ./demo/Demo.urp
./demo/Demo.urp: .fix-multy1
.PHONY: .cake3/tmp1
.cake3/tmp1: .fix-multy1
.PHONY: ./lib.urp
./lib.urp: .fix-multy1
.PHONY: .cake3/tmp0
.cake3/tmp0: .fix-multy1
.PHONY: ./CallbackFFI.o
./CallbackFFI.o: .fix-multy1
.PHONY: ./demo/Demo.sql
./demo/Demo.sql: .fix-multy1
.INTERMEDIATE: .fix-multy1
.fix-multy1: 
	-mkdir .cake3
	$(MAKE) -f ./Makefile $(MAKECMDGOALS)

endif
.PHONY: clean
clean: 
	-rm ./CallbackFFI.o ./demo/Demo.db ./demo/Demo.exe ./demo/Demo.sql ./demo/Demo.urp ./lib.urp .cake3/tmp0 .cake3/tmp1
	-rm -rf .cake3

endif
